---
title: "Coronavírus (COVID-19) -  Brasil "
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
---

```{r setup, include=FALSE}

library(flexdashboard)
library(ggplot2)
library(readxl)
library(tidyverse)
library(plotly)
library(ggmap)
library(flexdashboard)
library(maptools)     
library(spdep)          
library(cartography)    
library(tmap)           
library(leaflet)        
library(dplyr)
library(rgdal)
library(sp)
library(dplyr)
library(viridis)
library(RColorBrewer) 
library(ggplot2)
library(treemap) 
library(rvest)
library(plotly)
library(ggpubr)
library(highcharter)
library(tidyr) 
library(dplyr)
library(d3treeR)
library(digest)
library(RCurl)

#Corana vírus BR
# trilha 
setwd("C:/Users/Afonso Campos/OneDrive - ufpr.br/Cursos/corona dashboard Afonso/sitecovidbr/covid19br")

url1 <- getURL("https://raw.githubusercontent.com/wcota/covid19br/master/cases-brazil-states.csv")

dados <- read.csv(text = url1)
library(rsconnect)
deployApp()
#Renomenando as colunas 
colnames(dados)
names(dados)[names(dados) == 'newCases'] <- 'numero'
names(dados)[names(dados) == 'state'] <- 'estado'
names(dados)[names(dados) == 'date'] <- 'datas'
dados<-dados[, c(-2,-4, -6)]


##Removendo as linhas de total  
removelinha<-which(dados$estado=="TOTAL")
dados<-dados[-removelinha,]
estados2<-dados

#substituindo NA por zero
estados2[is.na(estados2)] <-  0
estados2$datas<-as.Date(estados2$datas)

#Criando a coluna regioes para cada estado 

#Norte
estados2$regioes[estados2$estado == "AM"|estados2$estado == "RR"|estados2$estado == "AP" | estados2$estado =="PA" |estados2$estado =="TO"|estados2$estado =="RO"|estados2$estado == "AC"] <- "NORTE"
#Nordeste
estados2$regioes[estados2$estado == "MA" |estados2$estado =="PI"|estados2$estado =="CE"|estados2$estado =="RN"|estados2$estado =="PE"|estados2$estado =="PB"|estados2$estado =="SE"|estados2$estado =="AL"|estados2$estado =="BA"]<- "NORDESTE"
#CENTRO_OESTE
estados2$regioes[estados2$estado == "MT"|estados2$estado =="MS"|estados2$estado =="GO"|estados2$estado == "DF"]<-"CENTRO-OESTE"
#SUDESTE
estados2$regioes[estados2$estado =="SP"|estados2$estado =="RJ"|estados2$estado =="ES"|estados2$estado =="MG"]<-"SUDESTE"
#SUL 
estados2$regioes[estados2$estado =="PR"|estados2$estado =="RS"|estados2$estado =="SC"|estados2$estado =="SUL"]<- "SUL"
             

#obetendo os dados acumulados por estado 
estados2<-estados2 %>% 
  group_by(estado) %>% 
  mutate(acumulado = cumsum(numero))


#mapa por regioes 
#acumulado por regiao e estado 
estados3<-estados2[,c(-1, -5)]
estados3<-estados3 %>% 
  group_by(regioes,estado) %>%
  summarise(acumulado = sum(numero))


#acumulado porestado 
estados4<-estados2[,c(-1, -5)]
estados4<-estados4 %>% 
  group_by(estado) %>%
  summarise(acumulado = sum(numero))    


#MAPA Do Brasil

shp <- readOGR("Mapa\\.", "BRUFE250GC_SIR", stringsAsFactors=FALSE, encoding="UTF-8")
ibge <- read.csv("estadosibge.csv", header=T,sep=",")
#jusntando com a referencia 
estados5<-merge(estados4,ibge, by.x= "estado", by.y = "UF")
#juntando com o shapefile 
estadoshape <- merge(shp,estados5, by.x = "CD_GEOCUF", by.y = "Código.UF")

#coordenadas 
proj4string(estadoshape) <- CRS("+proj=longlat +datum=WGS84 +no_defs") #adicionando coordenadas geográficas
Encoding(estadoshape$NM_ESTADO) <- "UTF-8"


#######grafico mapa brasil 
pal <- colorNumeric(c("yellow", "red", "darkred"), 1:max(estados5$acumulado)) #cores do mapa

state_popup <- paste0("<strong>Estado: </strong>", 
                      estadoshape$NM_ESTADO, 
                      "<br><strong>Número de Casos: </strong>", estadoshape$acumulado)

mapabra<-leaflet(data = estadoshape) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(fillColor = ~pal(estadoshape$acumulado), 
              fillOpacity = 0.8, 
              color = "#BDBDC3", 
              weight = 1, 
              popup = state_popup) %>%
  addLegend("bottomright", pal = pal, values = ~estadoshape$acumulado,
            title = "Número de casos",
            opacity = 1)


#obetendo os dados acumulados por data
dataacu<- estados2[, c(1,3)]
dataacu<-aggregate(.~datas, data=dataacu, FUN=sum)
dataacu$acumulado<-cumsum(dataacu$numero)
pal <- colorNumeric(c("yellow", "red", "darkred"), 1:max(estados5$acumulado))

#extraindo dados p caixas 
url2 <- getURL("https://raw.githubusercontent.com/wcota/covid19br/master/cases-brazil-total.csv")

mortesestado <- read.csv(text = url2)

#Renomenando as colunas 

names(mortesestado)[names(mortesestado) == 'totalCases'] <- 'Total de Casos'
names(mortesestado)[names(mortesestado) == 'state'] <- 'estado'
names(mortesestado)[names(mortesestado) == 'deaths'] <- 'Mortes'
mortesestado <- mortesestado[, c(2, 3, 6)]


##Removendo as linhas de total  
removelinha2<-which(mortesestado=="TOTAL")
mortesestado<-mortesestado[-removelinha2,]


#caixa numero de dias epidemia 
hoje<-as.Date(Sys.Date())
inicioepi<- as.Date("2020-02-25")
numerodias<- as.numeric(difftime(max(hoje),min(inicioepi), units = c("days")))

```


Mapa Brasil {data-icon="fa-globe"}
=============================
Row {data-width=150}
--------------------------------------
### dias 
```{r}

valueBox(value = numerodias,icon = "fa-calendar",caption = "Dias da Epidemia no Brasil*",color = "green")
```

### Data ultima atuliazação
```{r}

atualizacao<-format(max(estados2$datas), "%d/%m/%Y")

valueBox(value =atualizacao ,icon = "fa-calendar",caption = "Data de Atualização dos Dados",color = "green")
```

### Confirmados 
```{r}
valueBox(value = max(dataacu$acumulado),icon = "fa-ambulance",caption = "Número de Casos",color = "orange")
```


### Mortes
```{r}
valueBox(value = sum(mortesestado$Mortes),icon = "fa-user-plus",caption = "Mortes",color = "red")
```



Row
----------------------------------

### clicle nos estados e veja o número de casos 

```{r}
mapabra

```

### clique nas regioes 
```{r}

thm <- 
  hc_theme(
    colors = c("#1a6ecc", "#434348", "#90ed7d"),
    chart = list(
      backgroundColor = "transparent",
      style = list(fontFamily = "Source Sans Pro")
    ),
    xAxis = list(
      gridLineWidth = 1
    )
  )
tm2<-treemap(estados3, index=c("regioes","estado"),     vSize="acumulado", type="index",
        
        fontsize.labels=c(15,12),     
        fontcolor.labels=c("white","black"),
        fontface.labels=c(2,1),                  
        bg.labels=c("transparent"),             
        align.labels=list(
          c("center", "center"), 
          c("right", "bottom")
        ),                                  
        overlap.labels=0.5,                      
        inflate.labels=F,
        )

highchart() %>% 
  hc_add_series_treemap(tm2, allowDrillToNode = TRUE,
                        layoutAlgorithm = "squarified")%>% 
  hc_add_theme(thm)


```

Graficos Dia e Região{data-icon="fa-user-plus"}
==================
Row{data-height=250}
--------

### ponte com o mouse nas baras ou clique na legenda das regiões
```{r}
ggplot(estados2, aes(x=datas, y=numero, fill=regioes)) +
  geom_bar(stat="identity")+
  ggtitle("Número de Casos Confirmados Por Dia") +
  xlab("Data") +
  ylab("Total")+
  labs(fill = "Regiao:")+
  theme_classic()+
 theme(legend.position = "bottom")
ggplotly()
```


### passe o mouse na linha para observar os valores e dadas
```{r}
ggplot(data=dataacu, aes(x=datas, y=acumulado, group=1)) +
  geom_line(color="red")+
  ggtitle("Número de Casos Acumulado no Brasil")+
  geom_point(color="red")+
  theme_classic()
  ggplotly()
```


Row
----------


### passe o mouse nas linhas    
```{r}
ggplot(estados2,aes(x=datas, y= log(acumulado), color = estado) )+
  ggtitle("Logarítimo do Número de Casos Acumulado  Por Estado")+
  geom_line()+
  geom_point(aes(color= estado))+
  facet_wrap(estado~., ncol=9)+
  theme_pubclean()+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position = "none")

ggplotly()

```


Mortes por Estado{data-icon="fa-user-plus"}
==================

Row
----------


### passe o mouse ou clique em doentes e mortos   
```{r}
mortesestado$Doentes<- mortesestado$`Total de Casos`- mortesestado$Mortes

tabelamortes<-mortesestado[,-2] %>% gather(condicao,TOTAL, Doentes,Mortes, na.rm = FALSE, convert = FALSE)

tabelamortes$estado <- as.character(tabelamortes$estado)
tabelamortes$condicao<-as.character(tabelamortes$condicao)
tabelamortes$TOTAL<-as.numeric(tabelamortes$TOTAL)


ggplot(data = tabelamortes, aes(x = estado, y = TOTAL,fill= condicao)) + 
  geom_bar(stat = "identity") +
  coord_flip() +
  scale_fill_manual(values=c("#E69F00", "#c40606"))+
  labs(title = "Número de doentes e Mortes por Estado", 
       y = "Contagem", x = "Estados", fill = "Legenda:")+
  theme_classic()
  
ggplotly()%>%
  layout(legend = list(orientation = "h", x = 0.38, y =-0.2))

```


Sobre {data-icon="fa-user-plus"}
==================

Row
----------


**The Coronavirus Dashboard**

This Coronavirus dashboard provides an overview of the 2019 Novel Coronavirus COVID-19 (2019-nCoV) epidemic. This dashboard is built with R using the Rmakrdown framework and can easily reproduce by others. The code behind the dashboard available [here](https://github.com/RamiKrispin/coronavirus_dashboard)

**Data**

The input data for this dashboard is the [coronavirus](https://github.com/RamiKrispin/coronavirus) R package (dev version). The data and dashboard is refreshed on a daily bases. The raw data pulled from the Johns Hopkins University Center for Systems Science and Engineering (JHU CCSE) Coronavirus [repository](https://github.com/RamiKrispin/coronavirus-csv)




**Packages**

* Dashboard interface - the [flexdashboard](https://rmarkdown.rstudio.com/flexdashboard/) package. 
* Visualization - the [plotly](https://plot.ly/r/) package for the plots and [leaflet](https://rstudio.github.io/leaflet/) for the map
* Data manipulation - [dplyr](https://dplyr.tidyverse.org/), and [tidyr](https://tidyr.tidyverse.org/)
* Tables - the [DT](https://rstudio.github.io/DT/) package

**Deployment and reproducibly**

The dashboard was deployed to Github docs. If you wish to deploy and/or modify the dashboard on your Github account, you can apply the following steps:

* Fork the dashboard [repository](https://github.com/RamiKrispin/coronavirus_dashboard), or
* Clone it and push it to your Github package
* Here some general guidance about deployment of flexdashboard on Github page - [link](https://github.com/pbatey/flexdashboard-example)

For any question or feedback, you can either open an [issue](https://github.com/RamiKrispin/coronavirus_dashboard/issues) or contact me on [Twitter](https://twitter.com/Rami_Krispin).

**Contribution** 

The **Map** tab was contributed by [Art Steinmetz](@adababbage) on this [pull request](https://github.com/RamiKrispin/coronavirus_dashboard/pull/1). Thanks Art!
