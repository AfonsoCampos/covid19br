---
title: "Coronavírus (COVID-19) -  Brasil "
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
---

```{r setup, include=FALSE}

library(flexdashboard)
library(ggplot2)
library(readxl)
library(tidyverse)
library(plotly)
library(ggmap)
library(flexdashboard)
library(maptools)     
library(spdep)          
library(cartography)    
library(tmap)           
library(leaflet)        
library(dplyr)
library(rgdal)
library(sp)
library(dplyr)
library(viridis)
library(RColorBrewer) 
library(ggplot2)
library(treemap) 
library(rvest)
library(plotly)
library(ggpubr)
library(highcharter)
library(tidyr) 
library(dplyr)
library(d3treeR)
library(digest)
library(RCurl)

#Corana vírus BR
# trilha 
setwd("C:/Users/Afonso Campos/OneDrive - ufpr.br/Cursos/corona dashboard Afonso/sitecovidbr/covid19br")

url1 <- getURL("https://raw.githubusercontent.com/wcota/covid19br/master/cases-brazil-states.csv")

dados <- read.csv(text = url1)

#Renomenando as colunas 
#colnames(dados)
names(dados)[names(dados) == 'newCases'] <- 'numero'
names(dados)[names(dados) == 'state'] <- 'estado'
names(dados)[names(dados) == 'date'] <- 'datas'
names(dados)[names(dados) == 'deaths'] <- 'mortes'
dados<-dados[, c(-2,-4, -7)]


##Removendo as linhas de total  
removelinha<-which(dados$estado=="TOTAL")
dados<-dados[-removelinha,]
estados2<-dados

#substituindo NA por zero
estados2[is.na(estados2)] <-  0
estados2$datas<-as.Date(estados2$datas)

#Criando a coluna regioes para cada estado 

#Norte
estados2$regioes[estados2$estado == "AM"|estados2$estado == "RR"|estados2$estado == "AP" | estados2$estado =="PA" |estados2$estado =="TO"|estados2$estado =="RO"|estados2$estado == "AC"] <- "NORTE"
#Nordeste
estados2$regioes[estados2$estado == "MA" |estados2$estado =="PI"|estados2$estado =="CE"|estados2$estado =="RN"|estados2$estado =="PE"|estados2$estado =="PB"|estados2$estado =="SE"|estados2$estado =="AL"|estados2$estado =="BA"]<- "NORDESTE"
#CENTRO_OESTE
estados2$regioes[estados2$estado == "MT"|estados2$estado =="MS"|estados2$estado =="GO"|estados2$estado == "DF"]<-"CENTRO-OESTE"
#SUDESTE
estados2$regioes[estados2$estado =="SP"|estados2$estado =="RJ"|estados2$estado =="ES"|estados2$estado =="MG"]<-"SUDESTE"
#SUL 
estados2$regioes[estados2$estado =="PR"|estados2$estado =="RS"|estados2$estado =="SC"|estados2$estado =="SUL"]<- "SUL"
             

#obetendo os dados acumulados por estado 
estados2<-estados2 %>% 
  group_by(estado) %>% 
  mutate(acumulado = cumsum(numero))


#mapa por regioes 
#acumulado por regiao e estado 
estados3<-estados2[,c(2,4,5)]
estados3<-estados3 %>% 
  group_by(regioes,estado) %>%
  summarise(acumulado = sum(numero))


#acumulado porestado 
estados4<-estados2[,c(2, 4)]
estados4<-estados4 %>% 
  group_by(estado) %>%
  summarise(acumulado = sum(numero))    


#MAPA Do Brasil

shp <- readOGR("Mapa\\.", "BRUFE250GC_SIR", stringsAsFactors=FALSE, encoding="UTF-8")
ibge <- read.csv("estadosibge.csv", header=T,sep=",")
#jusntando com a referencia 
estados5<-merge(estados4,ibge, by.x= "estado", by.y = "UF")
#juntando com o shapefile 
estadoshape <- merge(shp,estados5, by.x = "CD_GEOCUF", by.y = "Código.UF")

#coordenadas 
proj4string(estadoshape) <- CRS("+proj=longlat +datum=WGS84 +no_defs") #adicionando coordenadas geográficas
Encoding(estadoshape$NM_ESTADO) <- "UTF-8"


#######grafico mapa brasil 
pal <- colorNumeric(c("yellow", "red", "darkred"), 1:max(estados5$acumulado)) #cores do mapa

state_popup <- paste0("<strong>Estado: </strong>", 
                      estadoshape$NM_ESTADO, 
                      "<br><strong>Número de Casos: </strong>", estadoshape$acumulado)

mapabra<-leaflet(data = estadoshape) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(fillColor = ~pal(estadoshape$acumulado), 
              fillOpacity = 0.8, 
              color = "#BDBDC3", 
              weight = 1, 
              popup = state_popup) %>%
  addLegend("bottomright", pal = pal, values = ~estadoshape$acumulado,
            title = "Número de casos",
            opacity = 1)


#obetendo os dados acumulados por data
dataacu<- estados2[, c(1,4)]
dataacu<-aggregate(.~datas, data=dataacu, FUN=sum)
dataacu$acumulado<-cumsum(dataacu$numero)
pal <- colorNumeric(c("yellow", "red", "darkred"), 1:max(estados5$acumulado))

#############dados mortes 
#extraindo dados p caixas 
url2 <- getURL("https://raw.githubusercontent.com/wcota/covid19br/master/cases-brazil-total.csv")

mortesestado <- read.csv(text = url2)

#Renomenando as colunas 

names(mortesestado)[names(mortesestado) == 'totalCases'] <- 'Total de Casos'
names(mortesestado)[names(mortesestado) == 'state'] <- 'estado'
names(mortesestado)[names(mortesestado) == 'deaths'] <- 'Mortes'
mortesestado <- mortesestado[, c(2, 3, 6)]


##Removendo as linhas de total  
removelinha2<-which(mortesestado=="TOTAL")
mortesestado<-mortesestado[-removelinha2,]


#caixa numero de dias epidemia 
hoje<-as.Date(Sys.Date())
inicioepi<- as.Date("2020-02-25")
numerodias<- as.numeric(difftime(max(hoje),min(inicioepi), units = c("days")))

```


Home {data-icon="fa-globe"}
=============================
Row {data-width=150}
--------------------------------------
### dias 
```{r}

valueBox(value = numerodias,icon = "fa-calendar",caption = "Dias da Epidemia no Brasil",color = "green")
```

### Data ultima atuliazação
```{r}

#atualizacao<-format(max(estados2$datas), "%d/%m/%Y")

datahora<- format(Sys.time(), '%d/%m/%Y - %Hh%m')


valueBox(value = datahora ,icon = "fa-calendar",caption = "Atualização dos Dados",color = "green")
```

### Confirmados 
```{r}
valueBox(value = max(dataacu$acumulado),icon = "fa-ambulance",caption = "Número de Casos",color = "orange")
```


### Mortes
```{r}
valueBox(value = sum(mortesestado$Mortes),icon = "fa-user-plus",caption = "Mortes",color = "red")
```

### Letalidade 
```{r}
valueBox(value = paste(round(sum(mortesestado$Mortes)/max(dataacu$acumulado)*100,1), "%", sep = ""), icon = "fa-user-plus",caption = "Letalidade",color = "red")
```

Row
----------------------------------

### Mapa do Brasil (Clique nas Regiões)

```{r}
mapabra

```

### Número de Casos Região e Estados (Clicável)
```{r}

thm <- 
  hc_theme(
    colors = c("#1a6ecc", "#434348", "#90ed7d"),
    chart = list(
      backgroundColor = "transparent",
      style = list(fontFamily = "Source Sans Pro")
    ),
    xAxis = list(
      gridLineWidth = 1
    )
  )
tm2<-treemap(estados3, index=c("regioes","estado"),     vSize="acumulado", type="index",
        
        fontsize.labels=c(15,12),     
        fontcolor.labels=c("white","black"),
        fontface.labels=c(2,1),                  
        bg.labels=c("transparent"),             
        align.labels=list(
          c("center", "center"), 
          c("right", "bottom")
        ),                                  
        overlap.labels=0.5,                      
        inflate.labels=F,
        )

highchart() %>% 
  hc_add_series_treemap(tm2, allowDrillToNode = TRUE,
                        layoutAlgorithm = "squarified")%>% 
  hc_add_theme(thm)


```

Casos: Estados e Regioes {data-icon="fa-user-plus"}
==================
Row{data-height=300}
--------

### Número de Casos Confirmados Dia 
```{r}
ggplot(estados2, aes(x=datas, y=numero, fill=regioes)) +
  geom_bar(stat="identity")+
  xlab("Datas") +
  ylab("Total")+
  labs(fill = "Regiao:")+
  theme_classic()+
 theme(legend.position = "bottom")
ggplotly()
```


### Número de Casos no Brasil Acumulado
```{r}
ggplot(data=dataacu, aes(x=datas, y=acumulado, group=1)) +
  geom_line(color="red")+
  xlab("Datas") +
  ylab("Acumulado")+
  geom_point(color="red")+
  theme_classic()
  ggplotly()
```

Row{.tabset .tabset-fade}
----------------------------------------------------

### Casos Região: Norte
```{r}

ggplot(estados2[estados2$regioes == "NORTE",]) + 
  geom_line(aes(datas, acumulado, color = estado))+
  xlab("Datas") +
  ylab("Acumulado")+
  theme_classic()

ggplotly(dynamicTicks = TRUE)%>%
  layout(hovermode = "x") %>%
  layout(margin = list(l = 50, r = 50, t = 60, b = 100),
         annotations = list(text = '*Clique no nome do estado na legenda para remover e ajustar a escala',
                            font = list(size = 12),
                            showarrow = FALSE,
                            xref = 'paper', x = 0,
                            yref = 'paper', y = -0.3))

```


### Casos Região: Nordeste
```{r}
ggplot(estados2[estados2$regioes == "NORDESTE",]) + 
  geom_line(aes(datas, acumulado, color = estado))+
  xlab("Datas") +
  ylab("Acumulado")+
  theme_classic()

ggplotly(dynamicTicks = TRUE)%>%
  layout(hovermode = "x") %>%
  layout(margin = list(l = 50, r = 50, t = 60, b = 100),
         annotations = list(text = '*Clique no nome do estado na legenda para remover e ajustar a escala',
                            font = list(size = 12),
                            showarrow = FALSE,
                            xref = 'paper', x = 0,
                            yref = 'paper', y = -0.3))
```

### Casos Região: Centro-Oeste
```{r}
ggplot(estados2[estados2$regioes == "CENTRO-OESTE",]) + 
  geom_line(aes(datas, acumulado, color = estado))+
  xlab("Datas") +
  ylab("Acumulado")+
  theme_classic()

ggplotly(dynamicTicks = TRUE)%>%
  layout(hovermode = "x") %>%
  layout(margin = list(l = 50, r = 50, t = 60, b = 100),
         annotations = list(text = '*Clique no nome do estado na legenda para remover e ajustar a escala',
                            font = list(size = 12),
                            showarrow = FALSE,
                            xref = 'paper', x = 0,
                            yref = 'paper', y = -0.3))
```

### Casos Região: Sudeste
```{r}
ggplot(estados2[estados2$regioes == "SUDESTE",]) + 
  geom_line(aes(datas, acumulado, color = estado))+
  xlab("Datas") +
  ylab("Acumulado")+
  theme_classic()

ggplotly(dynamicTicks = TRUE)%>%
  layout(hovermode = "x") %>%
  layout(margin = list(l = 50, r = 50, t = 60, b = 100),
         annotations = list(text = '*Clique no nome do estado na legenda para remover e ajustar a escala',
                            font = list(size = 12),
                            showarrow = FALSE,
                            xref = 'paper', x = 0,
                            yref = 'paper', y = -0.3))

```

### Casos Região: Sul
```{r}
ggplot(estados2[estados2$regioes == "SUL",]) + 
  geom_line(aes(datas, acumulado, color = estado))+
  xlab("Datas") +
  ylab("Acumulado")+
  theme_classic()

ggplotly(dynamicTicks = TRUE)%>%
  layout(hovermode = "x") %>%
  layout(margin = list(l = 50, r = 50, t = 60, b = 100),
         annotations = list(text = '*Clique no nome do estado na legenda para remover e ajustar a escala',
                            font = list(size = 12),
                            showarrow = FALSE,
                            xref = 'paper', x = 0,
                            yref = 'paper', y = -0.3))
```


Casos e Mortes (Acumulado){data-icon="fa-user-plus"}
==================

Row
----------------------------------

### São Paulo
```{r}
vSP<-mortesestado[mortesestado$estado == "SP",]  
gauge(vSP$Mortes,  min = 0, max = vSP$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

### Rio de Janeiro
```{r}
vRJ <- mortesestado[mortesestado$estado == "RJ",]  
gauge(vRJ$Mortes,  min = 0, max = vRJ$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

Row
----------------------------------

### Acre
```{r}
vAC<-mortesestado[mortesestado$estado == "AC",]  
gauge(vAC$Mortes,  min = 0, max = vAC$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```


### Alagoas
```{r}
vAL<-mortesestado[mortesestado$estado == "AL",]
gauge(vAL$Mortes,  min = 0, max = vAL$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

### Amapá
```{r}
vAP<-mortesestado[mortesestado$estado == "AP",]  
gauge(vAP$Mortes,  min = 0, max = vAP$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

### Amazonas
```{r}
vAM<-mortesestado[mortesestado$estado == "AM",]  
gauge(vAM$Mortes,  min = 0, max = vAM$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

### Bahia
```{r}
vBA<-mortesestado[mortesestado$estado == "BA",]  
gauge(vBA$Mortes,  min = 0, max = vBA$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

Row
----------------------------------

### Ceará
```{r}
vCE<-mortesestado[mortesestado$estado == "CE",]  
gauge(vCE$Mortes,  min = 0, max = vCE$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

### Distrito Federal
```{r}
vDF<-mortesestado[mortesestado$estado == "DF",]  
gauge(vDF$Mortes,  min = 0, max = vDF$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

### Espírito Santo
```{r}
vES<-mortesestado[mortesestado$estado == "ES",]  
gauge(vES$Mortes,  min = 0, max = vES$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

### Goiás
```{r}
vGO<-mortesestado[mortesestado$estado == "GO",] 
gauge(vGO$Mortes,  min = 0, max = vGO$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

### Maranhão
```{r}
vMA<-mortesestado[mortesestado$estado == "MA",]  
gauge(vMA$Mortes,  min = 0, max = vMA$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

Row
----------------------------------

### Mato Grosso
```{r}
vMT<-mortesestado[mortesestado$estado == "MT",]  
gauge(vMT$Mortes,  min = 0, max = vMT$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```


### Mato Grosso do Sul
```{r}
vMS <- mortesestado[mortesestado$estado == "MS",]  
gauge(vMS$Mortes,  min = 0, max = vMS$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

### Minas Gerais
```{r}
vMG<-mortesestado[mortesestado$estado == "MG",]  
gauge(vMG$Mortes,  min = 0, max = vMG$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

### Pará
```{r}
vPA<-mortesestado[mortesestado$estado == "PA",]  
gauge(vPA$Mortes,  min = 0, max = vPA$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

### Paraíba
```{r}
vPB<-mortesestado[mortesestado$estado == "PB",]  
gauge(vPB$Mortes,  min = 0, max = vPB$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

Row
----------------------------------

### Paraná
```{r}
vPR<-mortesestado[mortesestado$estado == "PR",]  
gauge(vPR$Mortes,  min = 0, max = vPR$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

### Pernambuco
```{r}
vPE<-mortesestado[mortesestado$estado == "PE",]  
gauge(vPE$Mortes,  min = 0, max = vPE$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

### Piauí
```{r}
vPI<-mortesestado[mortesestado$estado == "PI",]  
gauge(vPI$Mortes,  min = 0, max = vPI$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```


### Rio Grande do Norte
```{r}
vRN<-mortesestado[mortesestado$estado == "RN",]  
gauge(vRN$Mortes,  min = 0, max = vRN$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

### Rio Grande do Sul
```{r}
vRS<-mortesestado[mortesestado$estado == "RS",]  
gauge(vRS$Mortes,  min = 0, max = vRS$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

Row
----------------------------------

### Rondônia
```{r}
vRO<-mortesestado[mortesestado$estado == "RO",]  
gauge(vRO$Mortes,  min = 0, max = vRO$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

### Roraima
```{r}
vRR<-mortesestado[mortesestado$estado == "RR",]  
gauge(vRR$Mortes,  min = 0, max = vRR$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

### Santa Catarina
```{r}
vSC<-mortesestado[mortesestado$estado == "SC",]  
gauge(vSC$Mortes,  min = 0, max = vSC$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

### Sergipe
```{r}
vSE<-mortesestado[mortesestado$estado == "SE",]  
gauge(vSE$Mortes,  min = 0, max = vSE$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

### Tocantins
```{r}
vTO<-mortesestado[mortesestado$estado == "TO",]  
gauge(vTO$Mortes,  min = 0, max = vTO$`Total de Casos`,sectors = gaugeSectors(colors = c("red")))
```

Informações {data-icon="fa-address-card"}
==================


**Gráficos Coronavírus (COVID-19) BRASIL**

- Este site foi elaborado com intuito de fornecer gráficos sobre a evolução da pandemia do coronavírus no Brasil. As atualizações irão ocorrer conforme os dados forem disponibilizados, sendo o site atualizado de uma a duas vezes por dia. 

- Quase todos os gráficos disponibilizados são interativos e melhor observados em dispositivos como tabletes e computadores. Em celulares, recomenda-se a utilização em modo paisagem. 

- Novos gráficos poderão ser implementados. 

**Recomendações de Sites**

- Acredito que as melhores informações sobre o andamento da pandemia em português estão no canal do [Atila Lamarindo]( https://www.youtube.com/channel/UCSTlOTcyUmzvhQi6F8lFi5w) no youtube. 


**Dados e deploy** 

- Os dados para elaboração dos gráficos foram obtidos a partir do github do [Wesley Costa](https://github.com/wcota).

- Estava com o site pronto mas sem conseguir hospedar, graças ao exemplo no git do [Ramir Krispin](https://github.com/RamiKrispin) entendi como resolver o problema. 



**Contato ** 

Críticas, sugestões e contribuições podem ser enviadas por [e-mail](mailto:afonso@agronomo.eng.br), ou inbox no meu [twitter](https://twitter.com/GenAgronomica).

At.te, 

Eng. Agro. Amaro Afonso Campos de Azeredo

Doutor em genética e melhoramento
